# ì¶œì²˜1: "https://docs.upbit.com/reference/%EC%A0%84%EC%B2%B4-%EA%B3%84%EC%A2%8C-%EC%A1%B0%ED%9A%8C"
# ì¶œì²˜2: "https://github.com/sharebook-kr/pyupbit"
import requests, time, jwt, uuid, pyupbit, datetime
import pandas as pd
import numpy as np
from sendMail import send_email
import json

f = open("ì—…ë¹„íŠ¸ì •ë³´.private.json", "r")
api_key = json.load(f)
f.close()


# ======================================== ìˆ˜ì •í•  ë¶€ë¶„ ========================================
######################################################################
############################## ë¡œê·¸ì¸ ##############################
######################################################################
# ì—…ë¹„íŠ¸ì—ì„œ ë°œê¸‰ ë°›ì•˜ë˜ ë³¸ì¸ì˜ access_keyì™€ secret_key ì…ë ¥!!!
A_key = api_key["accessKey"]  # ë³¸ì¸ access_key í‚¤ë¡œ ë³€ê²½
S_key = api_key["secretKey"]  # ë³¸ì¸ secret_key í‚¤ë¡œ ë³€ê²½

######################################################################
############################## ë§¤ë„ ê°ì‹œ ##############################
######################################################################
# ë§¤ë„ ê°ì‹œ
## ëª‡ ì´ˆ ê°„ê²©ìœ¼ë¡œ ë§¤ë„ íƒ€ì´ë°ì„ ì²´í¬ í•  ê²ƒì¸ì§€
cycle_time = 1  # 1ë¶„ ê°„ê²©ìœ¼ë¡œ ì²´í¬
## ëª‡ ì‹œê°„ ë™ì•ˆ ë§¤ë„ íƒ€ì´ë°ì„ ì²´í¬ í•  ê²ƒì¸ì§€
loop_time = 60 * 24  # 24ì‹œê°„ ë™ì•ˆ ì²´í¬
# ==================================================

sec = 0 # ì‹œì‘ ê°’

# ì§€ê¸ˆ êµ¬ë§¤í•œ ìƒíƒœì¸ê°€? (ì§§ì€ì‹œê°„ë‚´ì— ë§ì´ êµ¬ë§¤ë˜ëŠ” í˜„ìƒ ë°©ì§€)
is_already_bought = False

down_bound = 19
up_bound = 56


while sec < (loop_time * 60):
    if (sec == 60 * 10):
        # 10ë¶„ì´ ì§€ë‚˜ë©´, êµ¬ë§¤í—€ë‹¤ëŠ” í”Œë˜ê·¸ë¥¼ Falseë¡œ ë§Œë“ ë‹¤. (10ë¶„ì´ë©´ ì¤‘ë³µêµ¬ë§¤í•´ë„ ê´œì°®ë‹¤ê³  ê°€ì •í•¨)
        is_already_bought = False
        
    if sec % 60 == 0:
        print(str(sec // 60) + 'ë¶„ ê²½ê³¼')
    if sec % 3600 == 0:
        send_email("ğŸ‘", "ğŸ‘ RSI 1ì‹œê°„ ì´ìƒë¬´")
    # ======================================== ìˆ˜ì •í•  ë¶€ë¶„ ========================================
    ######################################################################
    ############################## ë§¤ë§¤ ì¢…ëª© ì„ íƒ ##############################
    ######################################################################
    ## ë§¤ë§¤í•  ì¢…ëª© ì„¤ì •
    market_code = 'KRW-BTC'
    # ==========================================================================================

    ################################################################################
    ############################## ë‚´ ê³„ì¢Œ ë³´ìœ  ì›í™” ì¡°íšŒ ##############################
    ################################################################################
    ## currency: í™”íë¥¼ ì˜ë¯¸í•˜ëŠ” ì˜ë¬¸ ëŒ€ë¬¸ì ì½”ë“œ, balance: ì£¼ë¬¸ê°€ëŠ¥ ê¸ˆì•¡/ìˆ˜ëŸ‰, locked: ì£¼ë¬¸ ì¤‘ ë¬¶ì—¬ìˆëŠ” ê¸ˆì•¡/ìˆ˜ëŸ‰
    ## avg_buy_price: ë§¤ìˆ˜í‰ê· ê°€, avg_buy_price_modified: ë§¤ìˆ˜í‰ê· ê°€ ìˆ˜ì • ì—¬ë¶€, unit_currency: í‰ë‹¨ê°€ ê¸°ì¤€ í™”í
    ## APIë¡œ ì—…ë¹„íŠ¸ì—ì„œ ë‚´ ê³„ì¢Œ ì¡°íšŒ
    my_exchange_account = pd.DataFrame(requests.get("https://api.upbit.com/v1/accounts",
                                                    headers={"Authorization": 'Bearer {}'.format(
                                                        jwt.encode({'access_key': A_key,
                                                                    'nonce': str(uuid.uuid4())}, S_key))}).json())
    ## ë³´ìœ  ì›í™”
    now_krw = float(my_exchange_account[my_exchange_account['currency'] == 'KRW']['balance'].tail())

    ####################################################################################################
    ######################################## RSI ì§€í‘œ êµ¬í•˜ê¸°  ########################################
    ####################################################################################################
    ## APIë¡œ ì—…ë¹„íŠ¸ì—ì„œ 1ë¶„ ë‹¨ìœ„ì˜ "ê³ ê°€", "ì‹œê°€", "ì €ê°€", "ì¢…ê°€" "ê±°ë˜ëŸ‰" ì¡°íšŒ
    ohlcv_value = pyupbit.get_ohlcv(market_code, interval="minute1")
    ## ì• ë’¤ "ì¢…ê°€" ì°¨ì´ë¥¼ ë³€í™”ëŸ‰ "change"ë¡œ ì§€ì •
    ohlcv_value['change'] = ohlcv_value['close'] - ohlcv_value['close'].shift(1)
    ## ë³€í™”ëŸ‰ "change"ê°€ 0ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ìœ¼ë©´ "U"ì— "change" ê°’ì„ ì§€ì •í•˜ê³ , ì•„ë‹ˆë©´ "U"ì— 0ì„ ì§€ì •
    ohlcv_value['U'] = np.where(ohlcv_value['change'] >= 0, ohlcv_value['change'], 0)
    ## ë³€í™”ëŸ‰ "change"ê°€ 0ë³´ë‹¤ ì‘ìœ¼ë©´ "D"ì— "change" ì ˆëŒ€ê°’ì„ ì§€ì •í•˜ê³ , ì•„ë‹ˆë©´ "D"ì— 0ì„ ì§€ì •
    ohlcv_value['D'] = np.where(ohlcv_value['change'] < 0, ohlcv_value['change'].abs(), 0)
    ## "ewm"ë¼ëŠ” ì§€ìˆ˜ê°€ì¤‘í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í‰í™œê³„ìˆ˜ "alpha"ì— "1/14", ê³„ì‚°ì„ ìœ„í•œ ìµœì†Œ ê¸°ê°„ "min_periods"ì— "14"ë¥¼ ì…ë ¥í•˜ê³ 
    ## "U"ì™€ "D" ê°ê°ì˜ í‰ê· ì„ êµ¬í•´ì„œ ê°ê° "AU"ì™€ "AD"ë¡œ ì§€ì •
    ohlcv_value['AU'] = ohlcv_value['U'].ewm(alpha=1 / 14, min_periods=14).mean()
    ohlcv_value['AD'] = ohlcv_value['D'].ewm(alpha=1 / 14, min_periods=14).mean()
    ## "AU"ë¥¼ "AD"ë¡œ ë‚˜ëˆ  "RS"ë¡œ ì§€ì •
    ohlcv_value['RS'] = ohlcv_value['AU'] / ohlcv_value['AD']
    ## "AU"ë¥¼ "AU"ì™€ "AD"ì˜ í•©ìœ¼ë¡œ ë‚˜ëˆ  "RSI"ë¡œ ì§€ì •
    ohlcv_value['RSI'] = ohlcv_value['AU'] / (ohlcv_value['AU'] + ohlcv_value['AD'])
    ## ê°€ì¥ ìµœê·¼ "RSI"ê°’ì„ "RSI_value"ë¡œ ì§€ì •
    RSI_value = ohlcv_value[['RSI']].tail(n=1)
    # 0.xxë‹¨ìœ„ë¡œ ë‚˜ì™€ì„œ 100ê³±í•´ì¤Œ
    RSI_value_number = float(RSI_value['RSI']) * 100 
    print(f'1ë¶„ë´‰ RSIê°’ì€ {RSI_value_number}')

    ## ë³´ìœ  ì›í™”ê°€ 10000ì› ì´ìƒì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
    if now_krw > 10000:
        ## RSI ì§€í‘œê°€ down_bound% ì´í•˜ì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
        if RSI_value_number <= down_bound:
            ################################################################################
            #################### RSI ì§€í‘œê°€ 20% ì´í•˜ ê³¼ë§¤ë„ ìƒíƒœ ì‹œì¥ê°€ ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤í–‰ ####################
            ################################################################################
            
            # ì‹œì¥ê°€ ë§¤ìˆ˜
            ## ë³´ìœ  ì›í™”ì˜ 20%ê°€ 10000ì› ì´ìƒì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
            if round(now_krw * 0.2) >= 10000:
                ## ì£¼ë¬¸ ê¸ˆì•¡ì„ ë³´ìœ  ì›í™”ì˜ 20%ë¡œ ì§€ì •
                order_amount = round(now_krw * 0.2)
            ## ë³´ìœ  ì›í™”ì˜ 20%ê°€ 10000ì› ë¯¸ë§Œì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
            else:
                ## ì£¼ë¬¸ ê¸ˆì•¡ì„ ë³´ìœ  ì›í™”ì˜ 20%ê°€ ì•„ë‹Œ 10000ì›ìœ¼ë¡œ ì§€ì •
                order_amount = 10000

            ## uuid: ì£¼ë¬¸ì˜ ê³ ìœ  ì•„ì´ë””, side: ì£¼ë¬¸ ì¢…ë¥˜, ord_type: ì£¼ë¬¸ ë°©ì‹, price: ì£¼ë¬¸ ë‹¹ì‹œ í™”í ê°€ê²©, state: ì£¼ë¬¸ ìƒíƒœ
            ## market: ë§ˆì¼“ì˜ ìœ ì¼í‚¤, created_at: ì£¼ë¬¸ ìƒì„± ì‹œê°„, volume: ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì£¼ë¬¸ ì–‘, remaining_volume: ì²´ê²° í›„ ë‚¨ì€ ì£¼ë¬¸ ì–‘
            ## reserved_fee: ìˆ˜ìˆ˜ë£Œë¡œ ì˜ˆì•½ëœ ë¹„ìš©, remaining_fee: ë‚¨ì€ ìˆ˜ìˆ˜ë£Œ, paid_fee: ì‚¬ìš©ëœ ìˆ˜ìˆ˜ë£Œ, locked: ê±°ë˜ì— ì‚¬ìš©ì¤‘ì¸ ë¹„ìš©
            ## executed_volume: ì²´ê²°ëœ ì–‘, trades_count: í•´ë‹¹ ì£¼ë¬¸ì— ê±¸ë¦° ì²´ê²° ìˆ˜
            ## APIë¡œ ì—…ë¹„íŠ¸ì—ì„œ ì‹œì¥ê°€ ë§¤ìˆ˜ ì§„í–‰
            if(is_already_bought == False):
                buy_market_order_data = pd.DataFrame.from_dict(pyupbit.Upbit(A_key, S_key)
                                                          .buy_market_order(market_code, order_amount), orient='index').T
                is_already_bought = True
                send_email(f'RSI ì§€í‘œê°€ {down_bound}% ì´í•˜ ê³¼ë§¤ë„ ìƒíƒœ ì‹œì¥ê°€ ë§¤ìˆ˜ ' + datetime.datetime.now().strftime('%Y-%m-%d %Hì‹œ %Më¶„'), "ğŸ§¾ ë§¤ìˆ˜í–ˆì–´ìš”")
                print(f'RSI ì§€í‘œê°€ {down_bound}% ì´í•˜ ê³¼ë§¤ë„ ìƒíƒœ ì‹œì¥ê°€ ë§¤ìˆ˜ ' + datetime.datetime.now().strftime('%Y-%m-%d %Hì‹œ %Më¶„'))
            
        ## RSI ì§€í‘œê°€ up_bound% ì´ìƒì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
        elif RSI_value_number >= up_bound:
            ## ì¢…ëª© ë³´ìœ ëŸ‰ì´ ìˆëŠ” ê²½ìš° ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
            if pyupbit.Upbit(A_key, S_key).get_balance(market_code) > 0:
                ################################################################################
                ########## RSI ì§€í‘œê°€ up_bound% ì´ìƒ ë³´í†µê³¼ë§¤ìˆ˜ ìƒíƒœ ì‹œì¥ê°€(ìˆ˜ìµí™”) ë§¤ë„ ì£¼ë¬¸ ì‹¤í–‰ ##########
                ################################################################################
                # ì‹œì¥ê°€ ë§¤ë„
                order_quantity = pyupbit.Upbit(A_key, S_key).get_balance(market_code)

                ## uuid: ì£¼ë¬¸ì˜ ê³ ìœ  ì•„ì´ë””, side: ì£¼ë¬¸ ì¢…ë¥˜, ord_type: ì£¼ë¬¸ ë°©ì‹, price: ì£¼ë¬¸ ë‹¹ì‹œ í™”í ê°€ê²©, state: ì£¼ë¬¸ ìƒíƒœ
                ## market: ë§ˆì¼“ì˜ ìœ ì¼í‚¤, created_at: ì£¼ë¬¸ ìƒì„± ì‹œê°„, volume: ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì£¼ë¬¸ ì–‘, remaining_volume: ì²´ê²° í›„ ë‚¨ì€ ì£¼ë¬¸ ì–‘
                ## reserved_fee: ìˆ˜ìˆ˜ë£Œë¡œ ì˜ˆì•½ëœ ë¹„ìš©, remaining_fee: ë‚¨ì€ ìˆ˜ìˆ˜ë£Œ, paid_fee: ì‚¬ìš©ëœ ìˆ˜ìˆ˜ë£Œ, locked: ê±°ë˜ì— ì‚¬ìš©ì¤‘ì¸ ë¹„ìš©
                ## executed_volume: ì²´ê²°ëœ ì–‘, trades_count: í•´ë‹¹ ì£¼ë¬¸ì— ê±¸ë¦° ì²´ê²° ìˆ˜
                ## APIë¡œ ì—…ë¹„íŠ¸ì—ì„œ ì‹œì¥ê°€ ë§¤ë„ ì§„í–‰
                sell_market_order_data = pd.DataFrame.from_dict(
                    pyupbit.Upbit(A_key, S_key).sell_market_order(market_code, order_quantity), orient='index').T
                
                send_email(f'RSI ì§€í‘œê°€ {up_bound}% ì´ìƒ ê³¼ë§¤ìˆ˜ ìƒíƒœ ì‹œì¥ê°€(ìˆ˜ìµí™”) ë§¤ë„ ' + datetime.datetime.now().strftime('%Y-%m-%d %Hì‹œ %Më¶„'), "ğŸ·ï¸ ë§¤ë„í–ˆì–´ìš”")
                print(f'RSI ì§€í‘œê°€ {up_bound}% ì´ìƒ ê³¼ë§¤ìˆ˜ ìƒíƒœ ì‹œì¥ê°€(ìˆ˜ìµí™”) ë§¤ë„')
            ## ì¢…ëª© ë³´ìœ ëŸ‰ì´ ì—†ëŠ” ê²½ìš° ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
            else:
                #send_email(f'RSI ì§€í‘œê°€ {up_bound}% ì´ìƒ ê³¼ë§¤ìˆ˜ ìƒíƒœì§€ë§Œ ë§¤ë„í•  ì¢…ëª© ë³´ìœ ëŸ‰ ì—†ìŒ ' + datetime.datetime.now().strftime('%Y-%m-%d %Hì‹œ %Më¶„'), "âŒ ë§¤ë„ëª»í–ˆì–´ìš”")
                print(f'RSI ì§€í‘œê°€ {up_bound}% ì´ìƒ ê³¼ë§¤ìˆ˜ ìƒíƒœì§€ë§Œ ë§¤ë„í•  ì¢…ëª© ë³´ìœ ëŸ‰ ì—†ìŒ')
        ## RSI ì§€í‘œê°€ down_bound% ì´ˆê³¼ up_bound% ë¯¸ë§Œì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
        else:
            print('ëŒ€ê¸°')
    ## ë³´ìœ  ì›í™”ê°€ 10000ì› ë¯¸ë§Œì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
    else:
        ## ì¢…ëª© ë³´ìœ ëŸ‰ì´ ìˆëŠ” ê²½ìš° ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
        if pyupbit.Upbit(A_key, S_key).get_balance(market_code) > 0:
            ## RSI ì§€í‘œê°€ 20% ì´í•˜ì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
            if RSI_value_number <= down_bound:
                send_email(f'RSI ì§€í‘œê°€ {down_bound}% ì´í•˜ ê³¼ë§¤ë„ ìƒíƒœì§€ë§Œ ë§¤ìˆ˜í•  ì›í™” ë¶€ì¡± ' + datetime.datetime.now().strftime('%Y-%m-%d %Hì‹œ %Më¶„'), "âŒ ë§¤ìˆ˜ëª»í–ˆì–´ìš”")
                print(f'RSI ì§€í‘œê°€ {down_bound}% ì´í•˜ ê³¼ë§¤ë„ ìƒíƒœì§€ë§Œ ë§¤ìˆ˜í•  ì›í™” ë¶€ì¡±')
            ## RSI ì§€í‘œê°€ up_bound% ì´ìƒì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
            elif RSI_value_number >= up_bound:
                ################################################################################
                ########## RSI ì§€í‘œê°€ up_bound% ì´ìƒ ê³¼ë§¤ìˆ˜ ìƒíƒœ ì‹œì¥ê°€(ìˆ˜ìµí™”) ë§¤ë„ ì£¼ë¬¸ ì‹¤í–‰ ##########
                ################################################################################
                # ì‹œì¥ê°€ ë§¤ë„
                order_quantity = pyupbit.Upbit(A_key, S_key).get_balance(market_code)

                ## uuid: ì£¼ë¬¸ì˜ ê³ ìœ  ì•„ì´ë””, side: ì£¼ë¬¸ ì¢…ë¥˜, ord_type: ì£¼ë¬¸ ë°©ì‹, price: ì£¼ë¬¸ ë‹¹ì‹œ í™”í ê°€ê²©, state: ì£¼ë¬¸ ìƒíƒœ
                ## market: ë§ˆì¼“ì˜ ìœ ì¼í‚¤, created_at: ì£¼ë¬¸ ìƒì„± ì‹œê°„, volume: ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì£¼ë¬¸ ì–‘, remaining_volume: ì²´ê²° í›„ ë‚¨ì€ ì£¼ë¬¸ ì–‘
                ## reserved_fee: ìˆ˜ìˆ˜ë£Œë¡œ ì˜ˆì•½ëœ ë¹„ìš©, remaining_fee: ë‚¨ì€ ìˆ˜ìˆ˜ë£Œ, paid_fee: ì‚¬ìš©ëœ ìˆ˜ìˆ˜ë£Œ, locked: ê±°ë˜ì— ì‚¬ìš©ì¤‘ì¸ ë¹„ìš©
                ## executed_volume: ì²´ê²°ëœ ì–‘, trades_count: í•´ë‹¹ ì£¼ë¬¸ì— ê±¸ë¦° ì²´ê²° ìˆ˜
                ## APIë¡œ ì—…ë¹„íŠ¸ì—ì„œ ì‹œì¥ê°€ ë§¤ë„ ì§„í–‰
                sell_market_order_data = pd.DataFrame.from_dict(
                    pyupbit.Upbit(A_key, S_key).sell_market_order(market_code, order_quantity), orient='index').T
                
                send_email(f'RSI ì§€í‘œê°€ {up_bound}% ì´ìƒ ê³¼ë§¤ìˆ˜ ìƒíƒœ ì‹œì¥ê°€(ìˆ˜ìµí™”) ë§¤ë„ ' + datetime.datetime.now().strftime('%Y-%m-%d %Hì‹œ %Më¶„'), "ğŸ·ï¸ ë§¤ë„í–ˆì–´ìš”")
                print(f'RSI ì§€í‘œê°€ {up_bound}% ì´ìƒ ê³¼ë§¤ìˆ˜ ìƒíƒœ ì‹œì¥ê°€ ë§¤ë„')
            ## RSI ì§€í‘œê°€ down_boundì´ìƒ up_boundì´í•˜ì´ë©´ ë“¤ì—¬ ì“´ ì½”ë“œ ì‹¤í–‰
            else:
                print('ëŒ€ê¸°')
        ## ì›í™”ë„ ë¶€ì¡±í•˜ê³  ì¢…ëª© ë³´ìœ ëŸ‰ë„ ì—†ìŒ
        else:
            send_email('!!! ì›í™” ì…ê¸ˆ í•„ìš” !!! ì›í™”ë„ ë¶€ì¡±í•˜ê³  ì¢…ëª© ë³´ìœ ëŸ‰ë„ ì—†ìŒ ' + datetime.datetime.now().strftime('%Y-%m-%d %Hì‹œ %Më¶„'), "âŒ ì›í™”ì…ê¸ˆí•„ìš”!")
            print('!!! ì›í™” ì…ê¸ˆ í•„ìš” !!! ì›í™”ë„ ë¶€ì¡±í•˜ê³  ì¢…ëª© ë³´ìœ ëŸ‰ë„ ì—†ìŒ')
    time.sleep(cycle_time * 60)
    sec += (cycle_time * 60)
print(str(sec // 60) + 'ë¶„ ê²½ê³¼')
